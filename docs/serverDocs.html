<!DOCTYPE html>

<html>
<head>
  <title>serverDocs.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>serverDocs.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> express     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> mongoose    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

<span class="hljs-keyword">var</span> app = express();

mongoose.connect(<span class="hljs-string">'mongodb://localhost/raiseyourhand'</span>);

<span class="hljs-built_in">require</span>(<span class="hljs-string">'./config/middleware.js'</span>)(app, express);

<span class="hljs-built_in">module</span>.exports = app;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Facebook API keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = {
	<span class="hljs-string">'facebookAuth'</span> : {
		<span class="hljs-string">'clientID'</span> : <span class="hljs-string">'718396624937121'</span>, <span class="hljs-comment">// '1425134197808858', for queup.io</span>
		<span class="hljs-string">'clientSecret'</span> : <span class="hljs-string">'f5e9acd0b2cbfc6e46066cf185758ef8'</span> <span class="hljs-comment">// '02c6f7d9cd561b61d7c68a4fe71bdb1f' for queup.io</span>
	}
}
<span class="hljs-keyword">var</span> bodyParser  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>);
<span class="hljs-keyword">var</span> passport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport'</span>);
<span class="hljs-keyword">var</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cors'</span>);
<span class="hljs-keyword">var</span> prettyjson = <span class="hljs-built_in">require</span>(<span class="hljs-string">'prettyjson'</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(app, express)</span> </span>{
  <span class="hljs-keyword">var</span> port = process.env.PORT || <span class="hljs-number">8000</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Socket.io works by listening from the port in the index.js file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> server = app.listen(port);
  <span class="hljs-keyword">var</span> socketio = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io'</span>).listen(server);

  <span class="hljs-keyword">var</span> studentRouter = express.Router();
  <span class="hljs-keyword">var</span> teacherRouter = express.Router();
  <span class="hljs-keyword">var</span> classesRouter = express.Router();

  app.use(passport.initialize());
  app.use(bodyParser.urlencoded({extended: <span class="hljs-literal">true</span>}));
  app.use(bodyParser.json());

  app.use(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> </span>{
    res.header(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>);
    res.header(<span class="hljs-string">'Access-Control-Allow-Methods'</span>, <span class="hljs-string">'GET,PUT,POST,DELETE,OPTIONS'</span>);
    res.header(<span class="hljs-string">"Access-Control-Allow-Headers"</span>, <span class="hljs-string">"Origin, X-Requested-With, Content-Type, Accept"</span>);
    next();
  });

  app.use(express.static(__dirname + <span class="hljs-string">'/../../client'</span>));
  app.use(cors());
  <span class="hljs-built_in">require</span>(<span class="hljs-string">'./passport.js'</span>)(passport);
  <span class="hljs-keyword">var</span> unless = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, middleware)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"----&gt; req path "</span> + req.path);
        <span class="hljs-keyword">if</span> (path === req.path) {
            <span class="hljs-keyword">return</span> next();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> middleware(req, res, next);
        }
    };
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Every request to the server will be authiticated
We are currently passing the fbToken back to the server,
then Passport will send the token to Facebook and return a valid user ID and user token.</p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>This authenticates and then checks to see if the user is a teacher or student</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.use(unless(<span class="hljs-string">'/socket.io/'</span>, passport.authenticate(<span class="hljs-string">'facebook-token'</span>, {session:<span class="hljs-literal">false</span>})),
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res, next)</span> </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"******* GOING TO NEXT ---------------- "</span>);
      <span class="hljs-built_in">console</span>.log(req.user);
      next();
    }
  );</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Socket middleware to extract identification data from the initial socket connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  socketio.use(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(socket, next)</span> </span>{
    <span class="hljs-keyword">var</span> handshakeData = socket.request;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'handshakeData'</span>, handshakeData._query);
    next();
  });

  app.use(<span class="hljs-string">'/api/teachers'</span>, teacherRouter); 
  app.use(<span class="hljs-string">'/api/students'</span>, studentRouter); 
  app.use(<span class="hljs-string">'/api/classes'</span>, classesRouter); 

  <span class="hljs-built_in">require</span>(<span class="hljs-string">'../teachers/teachersRoutes.js'</span>)(teacherRouter);
  <span class="hljs-built_in">require</span>(<span class="hljs-string">'../students/studentsRoutes.js'</span>)(studentRouter, socketio);

  <span class="hljs-built_in">require</span>(<span class="hljs-string">'../sockets.js'</span>)(socketio);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="passport-authentication">Passport Authentication</h2>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> FacebookTokenStrategy = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport-facebook-token'</span>);
<span class="hljs-keyword">var</span> authConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./authkeys.js'</span>);
<span class="hljs-keyword">var</span> Student = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../students/studentsModel.js'</span>);
<span class="hljs-keyword">var</span> Teacher = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../teachers/teachersModel.js'</span>);
<span class="hljs-keyword">var</span> Q    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'q'</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(passport)</span> </span>{
	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"**** INSIDE OF PASSPORT ***"</span>)

	passport.use(<span class="hljs-keyword">new</span> FacebookTokenStrategy({
		clientID : process.env.ClientID || authConfig.facebookAuth.clientID,
		clientSecret : process.env.ClientSecret || authConfig.facebookAuth.clientSecret,
		passReqToCallback: <span class="hljs-literal">true</span>
	}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, accessToken, refereshToken, profile, done)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>User role is passed in from the front end inside the header
We grab basic user information from their Facebook profile which is passed in the passport callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> name = profile.displayName;
		<span class="hljs-keyword">var</span> fbPicture = profile.photos[<span class="hljs-number">0</span>].value;
		<span class="hljs-keyword">var</span> email = profile.emails[<span class="hljs-number">0</span>].value;

		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"----------- USER DATA : -----------------"</span>);
		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'USER EMAIL '</span> + email);
		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'USER ROLE '</span> + req.headers.user_role);
		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'USER NAME '</span> + name);
		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"----------------------------------------"</span>);

		<span class="hljs-keyword">if</span>(req.headers.user_role === <span class="hljs-string">"student"</span>){
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"-----------------------CREATING STUDENT ---------------------------"</span>);
			<span class="hljs-keyword">var</span> findOne = Q.nbind(Student.findOne, Student);
	    findOne({email: email})
	      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(user)</span> </span>{
	        <span class="hljs-keyword">if</span> (user) {
	        	<span class="hljs-keyword">return</span> user;
	        } <span class="hljs-keyword">else</span> {
	        	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"---------------- NO STUDENT FOUND, CREATING STUDENT -------------"</span>);
	          <span class="hljs-keyword">var</span> create = Q.nbind(Student.create, Student);
	          <span class="hljs-keyword">var</span> newStudent = {
						  name: name,
						  fbToken: accessToken,
						  email: email,
						  fbPicture : fbPicture
	          };
	          <span class="hljs-keyword">return</span> create(newStudent);
	        }
	      })
	      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(user)</span> </span>{
	      		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"----- CREATED NEW STUDENT , THE STUDENT IS"</span> + user);
						<span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, user);
	      })
	      .fail(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(error)</span> </span>{
	      	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"******* ERROR ******"</span>);
	      });
		}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(req.headers.user_role === <span class="hljs-string">"teacher"</span>){
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"-----------------------CREATING TEACHER ---------------------------"</span>);
			<span class="hljs-built_in">console</span>.log(email);			
			<span class="hljs-keyword">var</span> findOne = Q.nbind(Teacher.findOne, Teacher);
	    findOne({email: email})
	      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(user)</span> </span>{
	        <span class="hljs-keyword">if</span> (user) {
	        	<span class="hljs-keyword">return</span> user;
	        } <span class="hljs-keyword">else</span> {
	        	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"---------------- NO TEACHER FOUND, CREATING TEACHER -------------"</span>);
	          <span class="hljs-keyword">var</span> create = Q.nbind(Teacher.create, Teacher);
	          <span class="hljs-keyword">var</span> newTeacher = {
						  name: name,
						  fbToken: accessToken,
						  email: email,
						  fbPicture : fbPicture
	          };
	          <span class="hljs-keyword">return</span> create(newTeacher);
	        }
	      })
	      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(user)</span> </span>{
	      		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"----- CREATED NEW TEACHER , THE TEACHER IS"</span> + user);
						<span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, user);
	      })
	      .fail(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(error)</span> </span>{
	      	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"******* ERROR ******"</span>);
	      });
		}
	}
	));
}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="sockets-controller">Sockets Controller</h2>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(socketio)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Create socket in-memory data storage for teacher and student socket ids
and helper functions for checking and saving ids</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> socketDirectory = {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>sample data: {classID: socketID}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    teachers: {},</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>sample data: {student email: socketID}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    students: {}, 
    save: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(role, key, id)</span> </span>{
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>[role][key]) {
          <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>[role][key] !== id) {
            <span class="hljs-keyword">this</span>[role][key] = id;
            <span class="hljs-keyword">return</span> <span class="hljs-string">'updated'</span>;
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'**** found '</span>+ role +<span class="hljs-string">' in socketDirectory'</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-string">'confirmed'</span>;
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">this</span>[role][key] = id;
          <span class="hljs-keyword">return</span> <span class="hljs-string">'saved'</span>;
        }
    },
    lookup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(role, key)</span> </span>{
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>[role][key]) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>[role][key];
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'**** did not find '</span>+ role +<span class="hljs-string">' in socketDirectory'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      }
    } 
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Create reference to where current socket connections are stored</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> connectedSockets = socketio.sockets.connected;

  socketio.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(socket)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Socket listener for when a student presses the ‘raise hand’ button</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.on(<span class="hljs-string">'handraise'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
      <span class="hljs-keyword">if</span>(data) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>save student Socket id and email info to in-memory storage if it’s not there,
otherwise confirm and update info.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        socketDirectory.save(<span class="hljs-string">'students'</span>, data.email, socket.id);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>find teacher socket and send event to teacher</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(socketDirectory.lookup(<span class="hljs-string">'teachers'</span>, data.classID)) {
          socketio.to(socketDirectory.lookup(<span class="hljs-string">'teachers'</span>, data.classID)).emit(<span class="hljs-string">'studentRaisedHand'</span>, data);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'** error finding teacher socket id **'</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'no data in emit from student'</span>);
      }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Socket confirmation for when Student received notification that the Professor called him/her.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.on(<span class="hljs-string">'studentReceivedCall'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'student received teacher call, passing back data:'</span>, data);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>send message to teacher</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> teacherSocket = socketDirectory.lookup(<span class="hljs-string">'teachers'</span>, data.classID);
      <span class="hljs-keyword">if</span>(teacherSocket) {
        socketio.to(teacherSocket).emit(<span class="hljs-string">'studentConfirmation'</span>, data);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'*** error: failed student -&gt; teacher called-on confirmation, no teacher socket'</span>);
      }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Socket listener for when the Teacher is ready for Students to raise their hands</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.on(<span class="hljs-string">'classReady'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'** teacher connected **'</span>, data);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'** teacher socket id **'</span>, socket.id);
      <span class="hljs-keyword">if</span>(data) {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Save teacher Socket id and email info to in-memory storage if it doesn’t exist, otherwise confirm and update</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        socketDirectory.save(<span class="hljs-string">'teachers'</span>, data.classID, socket.id);
      }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Socket listener for when the teacher has received a student hand raise notification
 and sends the student confirmation that notification was received.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.on(<span class="hljs-string">'studentAddedToQueue'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
      <span class="hljs-keyword">var</span> studentSocket = socketDirectory.lookup(<span class="hljs-string">'students'</span>, data.email);
      <span class="hljs-keyword">if</span>(studentSocket) {
        socketio.to(studentSocket).emit(<span class="hljs-string">'queued'</span>, {classID: data.classID});
      }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Socket listener for when the teacher is calling on student.
Then we tell student they were called on by emitting a ‘calledOn’ event.
Atfer this function, the teacher waits for a confirmation from the student.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.on(<span class="hljs-string">'callOnStudent'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Logs current connection ids</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">Object</span>.keys(socketio.sockets.connected)); 

      <span class="hljs-keyword">var</span> studentSocket = socketDirectory.lookup(<span class="hljs-string">'students'</span>, data.email);</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Make sure the student is connected to the socket</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(studentSocket) {
        socketio.to(studentSocket).emit(<span class="hljs-string">'calledOn'</span>,data);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'*** error: Calling on Student failed, student socket not found'</span>);
      }

    });
    
  })
};<span class="hljs-comment">// Students Controller</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Classes = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../classes/classesModel.js'</span>);
<span class="hljs-keyword">var</span> Students = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./studentsModel.js'</span>);
<span class="hljs-keyword">var</span> Teachers = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../teachers/teachersModel.js'</span>);
<span class="hljs-keyword">var</span> Q    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'q'</span>);
<span class="hljs-keyword">var</span> jwt  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jwt-simple'</span>);
<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">var</span> Schema = mongoose.Schema;

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(socketio)</span> </span>{
  <span class="hljs-keyword">var</span> <span class="hljs-built_in">module</span> = {};

  <span class="hljs-built_in">module</span>.raiseHand = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res, next)</span> </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Hand Raised."</span>);
  };

  <span class="hljs-built_in">module</span>.classList = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> </span>{
    Students.findOne({email: req.user.email}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, data)</span> </span>{
      <span class="hljs-keyword">if</span>(data) {
        Classes.find({classID: { $<span class="hljs-keyword">in</span>: data.classIDs}}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, data)</span> </span>{
          <span class="hljs-built_in">console</span>.log(data,<span class="hljs-string">"Class List Data"</span>);
          res.status(<span class="hljs-number">200</span>).send(data);
        });
      }
    });
  };

  <span class="hljs-built_in">module</span>.joinClass =<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res, next)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Create object to hold data for this student</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> studentData = {};
      <span class="hljs-keyword">var</span> joinedClasses = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Get Student Data to put in Students array for this class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      Students.findOne({email: req.user.email}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, data)</span> </span>{
        <span class="hljs-keyword">if</span>(!err) {
          <span class="hljs-keyword">if</span>(data) {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'student joining class data:'</span>, data)
            studentData = {name: data.name ,email: data.email ,fbPicture: data.fbPicture};
            joinedClasses = data.classIDs;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Check if student already joined class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'checking if student already joined class:'</span>, joinedClasses, <span class="hljs-string">'indexof:'</span>, joinedClasses.indexOf(req.body.classID), <span class="hljs-string">'classID:'</span>, req.body.classID);
            <span class="hljs-keyword">if</span>(joinedClasses.indexOf(req.body.classID) &gt; -<span class="hljs-number">1</span>) {
              res.status(<span class="hljs-number">500</span>).send(<span class="hljs-string">'alreadyJoinedClass'</span>);
              <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Student hasn’t already joined class, so we can go ahead and add them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
              <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"---------- inside of join class --&gt; class id = "</span> + req.body.classID);
              Classes.findOne({classID : req.body.classID}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, data)</span> </span>{
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"classes.findOne data: "</span>, data);
                <span class="hljs-keyword">if</span>(err) {
                  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'** error finding class **'</span>, err)
                  <span class="hljs-keyword">return</span>;
                } 
                <span class="hljs-keyword">if</span> (data){ 
                  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"****** the class the student is trying to join , is found in DB *****"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Save user email to this class students list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  data.students.push(studentData);
                  data.save(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
                    <span class="hljs-keyword">if</span>(err) {
                      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'** error updating student **'</span>);
                    } <span class="hljs-keyword">else</span> {
                      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'** successfully updated student **'</span>);
                    }
                  });</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Now add class to this student’s list of classes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  Students.findOne({email: req.user.email}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, data)</span> </span>{
                    <span class="hljs-keyword">if</span>(err) {
                      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'** error finding student email **'</span>, err)
                      <span class="hljs-keyword">return</span>;
                    } 
                    <span class="hljs-keyword">if</span> (data){ 
                      data.classIDs.push(req.body.classID);
                      data.save(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
                        <span class="hljs-keyword">if</span>(err) {
                          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'** error updating student class IDs **'</span>);
                        } <span class="hljs-keyword">else</span> {
                          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'** successfully updated student class IDs **'</span>);
                          res.status(<span class="hljs-number">201</span>).send();
                        }
                      })
                    } <span class="hljs-keyword">else</span> {
                      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'*** Invalid student / Student email not found'</span>);
                      res.status(<span class="hljs-number">500</span>).send(<span class="hljs-string">'invalidEMAIL'</span>);
                    }
                  })

                } <span class="hljs-keyword">else</span> {
                  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'*** Invalid Class ID from student / Class ID not found'</span>);
                  res.status(<span class="hljs-number">500</span>).send(<span class="hljs-string">'invalidID'</span>);
                }
              });

            }
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'*** Did not find student when trying to join class'</span>);
            res.status(<span class="hljs-number">500</span>).send(<span class="hljs-string">'noStudentFound'</span>);
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'*** error in database trying to find Student to join class'</span>);
          res.status(<span class="hljs-number">500</span>).send(<span class="hljs-string">'studentDatabaseError'</span>);
        }
      });
  }
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">module</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h2 id="students-schema">Students Schema</h2>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">'use strict'</span>;
<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">var</span> Schema = mongoose.Schema;
<span class="hljs-keyword">var</span> findOrCreate = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose-findorcreate'</span>)


<span class="hljs-keyword">var</span> StudentSchema = <span class="hljs-keyword">new</span> Schema({
  name: <span class="hljs-built_in">String</span>,
  fbID: <span class="hljs-built_in">String</span>, 
  fbToken: <span class="hljs-built_in">String</span>,
  email: <span class="hljs-built_in">String</span>,
  fbPicture : <span class="hljs-built_in">String</span>,
  classIDs: <span class="hljs-built_in">Array</span>
});

StudentSchema.plugin(findOrCreate);
<span class="hljs-built_in">module</span>.exports = mongoose.model(<span class="hljs-string">'Student'</span>, StudentSchema);</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h2 id="students-routes">Students Routes</h2>

            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(app, socketio)</span> </span>{

  <span class="hljs-keyword">var</span> studentsController = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./studentsController.js'</span>)(socketio);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>app === userRouter injected from middlware.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.get(<span class="hljs-string">'/classList'</span>, studentsController.classList);
  app.post(<span class="hljs-string">'/joinClass'</span>, studentsController.joinClass);
  app.post(<span class="hljs-string">'/raiseHand'</span>, studentsController.raiseHand);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <h2 id="teachers-controller">Teachers Controller</h2>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Classes = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../classes/classesModel.js'</span>);
<span class="hljs-keyword">var</span> Teachers = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./teachersModel.js'</span>);
<span class="hljs-keyword">var</span> Students = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../students/studentsModel.js'</span>);
<span class="hljs-keyword">var</span> Q    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'q'</span>);
<span class="hljs-keyword">var</span> jwt  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jwt-simple'</span>);
<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">var</span> Schema = mongoose.Schema;


<span class="hljs-built_in">module</span>.exports = {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Add a class to the database</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addClass: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res, next)</span> </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"************** adding class to DBs *************"</span>);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"----------------&gt; req"</span>, req.user);
      <span class="hljs-keyword">var</span> create = Q.nbind(Classes.create, Classes);
      <span class="hljs-keyword">var</span> teacherID = req.user.email;
      <span class="hljs-keyword">var</span> teacherPic = req.user.fbPicture;
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"-----------&gt; user email "</span> + teacherID);
      <span class="hljs-keyword">var</span> makeid = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
          <span class="hljs-keyword">var</span> text = <span class="hljs-string">""</span>;
          <span class="hljs-keyword">var</span> possible = <span class="hljs-string">"abcdefghijklmnopqrstuvwxyz0123456789"</span>;
          <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++ )
              text += possible.charAt(<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * possible.length));
          <span class="hljs-keyword">return</span> text;
      }
      <span class="hljs-keyword">var</span> classId = makeid();
      <span class="hljs-keyword">var</span> newClass = {
        name: req.body.classTitle,
        teacher: teacherID,
        teacherPic: teacherPic,
        classID: classId
      };
      create(newClass)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(classObj)</span> </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"!!!!!!!!!!!! USER IS !!!!!!!!!!!!!!!"</span> + classObj);
        res.status(<span class="hljs-number">201</span>).json(classObj);
      })
      .fail(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(error)</span> </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"******* ERROR ******  "</span> + error);
      });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Gets classes for a teacher from the database</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getClasses: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res, next)</span> </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'**********Inside Teachers Controller - get class'</span>)

    Classes.find({teacher : req.user.email }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, dbData)</span></span>{
      <span class="hljs-keyword">if</span>(!err){
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"-------found teacher access token in class collection, dbData below---------"</span>);
        <span class="hljs-built_in">console</span>.log(dbData)
        
        <span class="hljs-keyword">var</span> classes = [];
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; dbData.length; i++){
          classes.push(dbData[i])
        }

        res.json(classes);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> err;
      }
    })
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Gets class name and id for a class by class name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getClassInfo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res, next)</span> </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'**********Inside Teachers Controller - Get Class Info'</span>)
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"req.body.className: "</span>, req.body.className)

    Classes.findOne({name : req.body.className }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, dbData)</span></span>{
      <span class="hljs-keyword">if</span>(!err){
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"-------found className in classes collection, dbData below---------"</span>);
        <span class="hljs-built_in">console</span>.log(dbData)

        <span class="hljs-keyword">var</span> result = {
          className: dbData.name,
          classID: dbData.classID
        }

        res.json(result);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> err;
      }
    })
  },

  getStudentList: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span></span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"**********Inside Teachers Controller - In Session - Student List - GET request"</span>)
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"req.query: "</span>, req.query);

    Classes.findOne({classID : req.query.classid }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, dbData)</span></span>{
      <span class="hljs-keyword">if</span>(dbData){
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"-------found className in classes collection, dbData below---------"</span>);

        res.json({results: dbData.students});
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> err;
      }
    })
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Gets the name, email, picture and classes for the teacher</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getTeacherData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req,res,next)</span> </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'***** getTeacherData controller ******'</span>);
    Teachers.findOne({email: req.user.email}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, dbData)</span> </span>{
      <span class="hljs-keyword">if</span>(!err) {

        Classes.find({teacher: req.user.email}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, classes)</span> </span>{
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'**** here are classes ****'</span>, classes)
          <span class="hljs-keyword">var</span> classesList = classes;

        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'***** found teacher, '</span>+ req.user.email +<span class="hljs-string">' returning data ****'</span>);
        <span class="hljs-keyword">var</span> teacherData = {
          name: dbData.name,
          email: dbData.email,
          fbPicture: dbData.fbPicture,
          classes: classesList
        };
        res.json(teacherData);
          
        });
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> err;
      }
    });
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h2 id="teachers-schema">Teachers Schema</h2>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">'use strict'</span>;
<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">var</span> Schema = mongoose.Schema;
<span class="hljs-keyword">var</span> findOrCreate = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose-findorcreate'</span>)


<span class="hljs-keyword">var</span> TeacherSchema = <span class="hljs-keyword">new</span> Schema({
  name: <span class="hljs-built_in">String</span>,
  fbID: <span class="hljs-built_in">String</span>, 
  fbToken: <span class="hljs-built_in">String</span>,
  email: <span class="hljs-built_in">String</span>,
  fbPicture : <span class="hljs-built_in">String</span>,
  classes: []
});

TeacherSchema.plugin(findOrCreate);
<span class="hljs-built_in">module</span>.exports = mongoose.model(<span class="hljs-string">'Teacher'</span>, TeacherSchema);</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <h2 id="teachers-routes">Teachers Routes</h2>

            </div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> teacherController = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./teachersController.js'</span>);
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(app)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>app === userRouter injected from middlware.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.get(<span class="hljs-string">'/getClassList'</span>, teacherController.getClasses);
  app.get(<span class="hljs-string">'/getStudentList/:classid?'</span>, teacherController.getStudentList);
  app.get(<span class="hljs-string">'/getTeacherData'</span>, teacherController.getTeacherData);
  
  app.post(<span class="hljs-string">'/getClassInfo'</span>, teacherController.getClassInfo);
  app.post(<span class="hljs-string">'/addClass'</span>, teacherController.addClass);
};
<span class="hljs-keyword">var</span> Student = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../students/studentsModel.js"</span>);

<span class="hljs-built_in">module</span>.exports = {

  getStudents: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Return students in the class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  }

};<span class="hljs-string">'use strict'</span>;
<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">var</span> Schema = mongoose.Schema;
<span class="hljs-keyword">var</span> findOrCreate = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose-findorcreate'</span>);
<span class="hljs-keyword">var</span> ObjectIdSchema = Schema.ObjectId;
<span class="hljs-keyword">var</span> ObjectId = mongoose.Types.ObjectId;

<span class="hljs-keyword">var</span> ClassSchema = <span class="hljs-keyword">new</span> Schema({
  name: <span class="hljs-built_in">String</span>,
  classID: <span class="hljs-built_in">String</span>, 
  teacher: <span class="hljs-built_in">String</span>,
  teacherPic: <span class="hljs-built_in">String</span>,
  students: <span class="hljs-built_in">Array</span>
});

ClassSchema.plugin(findOrCreate);
<span class="hljs-built_in">module</span>.exports = mongoose.model(<span class="hljs-string">'Class'</span>, ClassSchema);
<span class="hljs-keyword">var</span> classesController = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./classesController.js'</span>);
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(app)</span> </span>{

  app.get(<span class="hljs-string">"/getStudents"</span>, classesController.getStudents);

};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
